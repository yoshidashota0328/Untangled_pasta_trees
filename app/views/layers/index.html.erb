<body>
  <div class="client"></div>
  <div id="message"></div>
  <button id="treetop-pos-reset">treetop reset</button>
</body>

<script>
  //グローバル変数
  //$('.tooltip').hide();
  var p1;
  var p2;
  var pX1;
  var pY1;
  var pX2;
  var pY2;
  var treetop_i;
  var tree_pos;
  var title_posX;
  var title_posY;
  let before_parent_posX;
  let before_parent_posY;
  var db_id = 1;
  var layer_id = 1;
  var q = 0;
  var l = 0;
  var this_id = "";
  var box_count = 0;
  var z_index_cnt = 1;
  var eazy_mde = {}; 
  var easy_hide_id
  var fk_user_id;
  var fk_tree_id;
  $(document).ready(function(){
    reposition();
  });
  //タイトルboxをbodyに追加
  function reposition(){
    $.each(gon.layers, function(index, elem){
      if(elem.layer_id == 1){
          treetop_i = elem.id;
          layer_id = elem.layer_id;
          fk_user_id = elem.user_id
          fk_tree_id = elem.tree_id
          title_posX = elem.positionX;
          title_posY = elem.positionY;
          before_parent_posX = title_posX;
          before_parent_posY = title_posY;
          $('body').append('<div class="tree-wrapper"><div class="leaf tree_title" style="left: ' + elem.positionX + 'px; top: ' + elem.positionY + 'px;" id="1">treetop<form action="layers/' + treetop_i + '" method="post"><input type="hidden" name="_method" value="patch" /><input type="hidden" id="db_id" name="db_id" value="' + treetop_i + '"><input type="hidden" id="layer_id" name="layer_id" value="' + layer_id + '"><input type="hidden" id="user_id" name="user_id" value="' + fk_user_id + '"><input class="title" type="text" name="title" value="' + elem.title + '"></br><button id="left-branch">+</button><button id="left-down-branch">+</button><button id="right-down-branch">+</button><button id="right-branch">+</button><div class="tooltip" id="tooltip-id' + layer_id + '"><button id="close-window">×</button><input type="text" class="not" name="positionX" id="posX1" value="' + elem.positionX + '"><input type="text" class="not" name="positionY" id="posY1" value="' + elem.positionY + '"></br><div id="easy-hide1"><textarea name="body" class="leaf-body" id="leaf-body1">' + elem.body + '</textarea></div></br><input type="submit" value="save" class="save"></div></form></div></div>')
          $('.tooltip').hide();
          $('#easy-hide1').hide();
          eazy_mde['easyMDE1'] = new EasyMDE({element: document.getElementById('leaf-body1'), maxHeight: "550px"});
      }else if(elem.layer_id !== 1){
        db_id = elem.id;
        layer_id = elem.layer_id;
        console.log(title_posX + elem.positionX); 
        var parent_posX = $('#posX' + elem.parent_id).val();
        var parent_posY = $('#posY' + elem.parent_id).val();
        var parent_all_pos = $('#' + elem.parent_id).position();
        /*if(elem.parent_id == 1){
          before_parent_posX = Number(title_posX);
          before_parent_posY = Number(title_posY);
          console.log("lineX" + before_parent_posX)
        }else if(elem.parent_id !== 1){
          before_parent_posX = Number(before_parent_posX) + Number(parent_posX);
          before_parent_posY = Number(before_parent_posY) + Number(parent_posY);
          console.log("2lineX" + before_parent_posX)
        }*/
        before_parent_posX = Number(parent_all_pos?.left);
        before_parent_posY = Number(parent_all_pos?.top);
        var leaf_posX = Number(before_parent_posX) + Number(elem.positionX);
        var leaf_posY = Number(before_parent_posY) + Number(elem.positionY);
        var svg_width = Math.abs(leaf_posX - before_parent_posX);
        var svg_height = Math.abs(leaf_posY - before_parent_posY);
        console.log("parent_posX" + parent_posX); 
        $('.tree_title').after('<div class="leaf" style="left: ' + leaf_posX + 'px; top: ' + leaf_posY + 'px;" id="' + layer_id + '">' + elem.layer_id + '</br><form action="layers/' + db_id + '" method="post"><input type="hidden" name="_method" value="patch" /><input type="hidden" id="db_id" name="db_id" value="' + db_id + '"><input type="hidden" id="layer_id" name="layer_id" value="' + layer_id + '"><input type="hidden" id="user_id" name="user_id" value="' + fk_user_id + '"><input class="title" type="text" name="title" value="' + elem.title + '"></br><button id="left-branch">+</button><button id="left-down-branch">+</button><button id="right-down-branch">+</button><button id="right-branch">+</button><div class="tooltip" id="tooltip-id' + layer_id + '"><button id="close-window">×</button><input type="text" class="parent not" name="parent_id" id="parent' + layer_id + '" value="' + elem.parent_id + '"><input type="text" class="not" name="positionX" id="posX' + layer_id + '" value="' + elem.positionX + '"><input type="text" class="not" name="positionY" id="posY' + layer_id + '" value="' + elem.positionY + '"></br><div id="easy-hide' + layer_id + '"><textarea name="body" class="leaf-body" id="leaf-body' + layer_id + '">' + elem.body + '</textarea></div></br><input type="submit" value="save" class="save"></div></form></div><div class="line-box" id="line' + layer_id + '" style="left: ' + before_parent_posX + 'px; top: ' + before_parent_posY + 'px;"></div>')
        var line_id = "line" + layer_id 
        var line_pos = document.getElementById(line_id);   
        console.log("line_pos" + line_id); 
        if(Math.sign(leaf_posX - before_parent_posX) !== -1){
          line_pos.style.left = before_parent_posX + 105 + "px";
          line_pos.style.top = before_parent_posY + 70 + "px";
          $("#" + line_id).addClass("right-down-line");
        }else if(Math.sign(leaf_posX - before_parent_posX) == -1){
          line_pos.style.left = before_parent_posX + 105 - svg_width +  "px";
          line_pos.style.top = before_parent_posY + 70 + "px";
          $("#" + line_id).addClass("left-down-line");
        }
        line_pos.style.width = svg_width + "px";
        line_pos.style.height = svg_height + "px";
        $('.tooltip').hide();
        $('#easy-hide' + layer_id).hide();
        //$('').after('<svg style="left: ' + leaf_posX + 'px; top: ' + leaf_posY + 'px;" width="' + svg_width + 'px" height="' + svg_height + 'px" viewBox="' + svg_posX + ' ' + svg_posY + ' ' + svg_width + ' ' + svg_height + '"><line x1="' + svg_posX + '" y1="' + svg_posY + '" x2="' + leaf_posX + '" y2="' + leaf_posY + '" stroke="black" stroke-width="5"/></svg>');
        //before_parent_posX = Number(parent_posX);
        //before_parent_posY = Number(parent_posY);
        eazy_mde['easyMDE' + layer_id] = new EasyMDE({element: document.getElementById("leaf-body" + layer_id + ""), maxHeight: "550px"});
      }
    })
    //メッセージのアニメーション
    var message = document.getElementById("message");
    message.innerText = "Reloading completed";
    msgAnimation()
  };
  //アニメーション関数
  function msgAnimation() {
    message.classList.add("fade-in");
    setTimeout(function(){
      message.classList.remove("fade-in");
      message.classList.add("fade-out");
    }, 2000);
    setTimeout(function(){
      message.classList.remove("fade-out");
    }, 4000);
  }

  /*$(document).on('click','#create_btn', function(evt){
    box_count = 1;
  });*/
  //セーブボタンを押したときにセーブ完了表示
  $(document).on('click', '.save', function(){
    var message = document.getElementById("message");
    message.innerText = "Data save completed";
    msgAnimation()
  });
  //拡大ボタンで全画面表示
  $(document).on('click', '.show', function(evt){
    $('.tooltip').css({'position':'fixed','left':'0px','top':'20px','width':'100vw','height':'100vh'});
    evt.stopPropagation()
  });
  //treetopのポジションをリセットする。
  $(document).on('click', '#treetop-pos-reset', function(){
    $.ajax({url: "layers/" + treetop_i +"", type: "POST", data: {positionX: 500, positionY: 30, "_method": "PATCH"}});
  });

  /*$(document).on('click','#pos_reset', function(evt){
    $("#posX").val(500);
    $("#posY").val(30);
  });*/

  //クリックした要素のid、座表を取得 

  /*$(document).on('click', '.leaf', function(evt) {
    this_id = $(this).attr('id');
    console.log("this_id" + this_id);
    evt.stopPropagation();
  });*/
  //マウスオーバーでid取得
  $(function(){
    $(document).on({
      'mouseenter' : function(evt) {
        this_id = $(this).attr('id');
        console.log("this_id" + this_id);
      }
    }, '.leaf');
  })  
  //右下にボックスを作成
  $(document).on('click','#right-down-branch', function(evt){
      p1 = $(evt.target).closest(".leaf").position();
      var parent_elem = (evt.target).closest(".leaf");
      var parent_id = $(parent_elem).attr('id');
      var parent_all_pos = $('#' + parent_id).position();
      var parent_posX = parent_all_pos.left;
      var parent_posY = parent_all_pos.top;
      layer_id++;
      pX1 = parent_posX + 150;
      pY1 = parent_posY + 200;
      var line_left = parent_posX + 105;
      var line_top = parent_posY + 70;
      var setX = 150;
      var setY = 200;
      setTimeout(function(){
        $.ajax({url: "layers/new", type: "GET", data: {layer_id: layer_id, setX: setX, setY: setY, parent_id: this_id, user_id: fk_user_id, tree_id: fk_tree_id}});
        console.log("new action")
      }, 100);
      $(event.target).closest(".leaf").after('<div class="leaf right-down" id="' + layer_id + '" style="left: ' + pX1 + 'px; top: ' + pY1 + 'px;">' + layer_id + '<form action="layers/' + gon.db_id + '" method="post"><input type="hidden" name="_method" value="patch" /><input type="hidden" id="db_id" name="db_id" value="' + gon.db_id + '"><input type="hidden" id="layer_id" name="layer_id" value="' + layer_id + '"><input type="hidden" id="user_id" name="user_id" value="' + fk_user_id + '"><input class="title" type="text" name="title"></br><button id="left-branch">+</button><button id="left-down-branch">+</button><button id="right-down-branch">+</button><button id="right-branch">+</button><div class="tooltip" id="tooltip-id' + layer_id + '"><button id="close-window">×</button><input type="text" class="parent not" name="parent_id" id="parent' + layer_id + '"><input type="text" class="not" name="positionX" id="posX' + layer_id + '"><input type="text" class="not" name="positionY" id="posY' + layer_id + '"></br><div id="easy-hide' + layer_id + '"><textarea name="body" class="leaf-body" id="leaf-body' + layer_id + '"></textarea></div></br><input type="submit" value="save" class="save"></div></form></div><div class="line-box right-down-line" id="line' + layer_id + '" style="left: ' + line_left + 'px; top: ' + line_top + 'px; width: 150px; height: 200px;"></div>')
      setTimeout(function(){
        $("#posX" + layer_id).val(150);
        $("#posY" + layer_id).val(200);
        $("#parent" + layer_id).val(this_id);
      }, 200);
      $('.tooltip').hide();
      $('.easy-hide').hide();
      eazy_mde['easyMDE' + layer_id] = new EasyMDE({element: document.getElementById("leaf-body" + layer_id + ""), maxHeight: "550px"});
  });
  //左下にボックスを作成
  $(document).on('click','#left-down-branch', function(evt){
      p1 = $(evt.target).closest(".leaf").position();
      var parent_elem = (evt.target).closest(".leaf");
      var parent_id = $(parent_elem).attr('id');
      console.log("parent_id" + parent_id);
      var parent_all_pos = $('#' + parent_id).position();
      var parent_posX = parent_all_pos.left;
      var parent_posY = parent_all_pos.top;
      console.log(p1);
      layer_id++;
      pX1 = parent_posX - 150;
      pY1 = parent_posY + 200;
      var line_left = parent_posX - 45;
      var line_top = parent_posY + 70;
      var setX = -150;
      var setY = 200;
      setTimeout(function(){
        $.ajax({url: "layers/new", type: "GET", data: {layer_id: layer_id, setX: setX, setY: setY, parent_id: this_id, user_id: fk_user_id, tree_id: fk_tree_id}});
      }, 100);
      $(event.target).closest(".leaf").after('<div class="leaf left-down" id="' + layer_id + '" style="left: ' + pX1 + 'px; top: ' + pY1 + 'px;">' + layer_id + '<form action="layers/' + gon.db_id + '" method="post"><input type="hidden" name="_method" value="patch" /><input type="hidden" id="db_id" name="db_id" value="' + gon.db_id + '"><input type="hidden" id="layer_id" name="layer_id" value="' + layer_id + '"><input type="hidden" id="user_id" name="user_id" value="' + fk_user_id + '"><input class="title" type="text" name="title"></br><button id="left-branch">+</button><button id="left-down-branch">+</button><button id="right-down-branch">+</button><button id="right-branch">+</button><div class="tooltip" id="tooltip-id' + layer_id + '"><button id="close-window">×</button><input type="text" class="parent not" name="parent_id" id="parent' + layer_id + '"><input type="text" class="not" name="positionX" id="posX' + layer_id + '"><input type="text" class="not" name="positionY" id="posY' + layer_id + '"></br><div id="easy-hide' + layer_id + '"><textarea name="body" class="leaf-body" id="leaf-body' + layer_id + '"></textarea></div></br><input type="submit" value="save" class="save"></div></form></div><div class="line-box left-down-line" id="line' + layer_id + '" style="left: ' + line_left + 'px; top: ' + line_top + 'px; width: 150px; height: 200px;"></div>')
      setTimeout(function(){
        $("#posX" + layer_id).val(-150);
        $("#posY" + layer_id).val(200);
        $("#parent" + layer_id).val(this_id);
      }, 200);
      $('.tooltip').hide();
      $('.easy-hide').hide();
      eazy_mde['easyMDE' + layer_id] = new EasyMDE({element: document.getElementById("leaf-body" + layer_id + ""), maxHeight: "550px"});
  });
  //右
  $(document).on('click','#right-branch', function(evt){
      p1 = $(evt.target).closest(".leaf").position();
      var parent_elem = (evt.target).closest(".leaf");
      var parent_id = $(parent_elem).attr('id');
      console.log("parent_id" + parent_id);
      var parent_all_pos = $('#' + parent_id).position();
      var parent_posX = parent_all_pos.left;
      var parent_posY = parent_all_pos.top;
      layer_id++;
      pX1 = parent_posX + 300;
      pY1 = parent_posY;
      var line_left = parent_posX;
      var line_top = parent_posY + 70;
      var setX = 300;
      var setY = 0;
      setTimeout(function(){
        $.ajax({url: "layers/new", type: "GET", data: {layer_id: layer_id, setX: setX, setY: setY, parent_id: this_id, user_id: fk_user_id, tree_id: fk_tree_id}});
      }, 100);
      $(event.target).closest(".leaf").after('<div class="leaf right-down" id="' + layer_id + '" style="left: ' + pX1 + 'px; top: ' + pY1 + 'px;">' + layer_id + '<form action="layers/' + gon.db_id + '" method="post"><input type="hidden" name="_method" value="patch" /><input type="hidden" id="db_id" name="db_id" value="' + gon.db_id + '"><input type="hidden" id="layer_id" name="layer_id" value="' + layer_id + '"><input type="hidden" id="user_id" name="user_id" value="' + fk_user_id + '"><input class="title" type="text" name="title"></br><button id="left-branch">+</button><button id="left-down-branch">+</button><button id="right-down-branch">+</button><button id="right-branch">+</button><div class="tooltip" id="tooltip-id' + layer_id + '"><button id="close-window">×</button><input type="text" class="parent not" name="parent_id" id="parent' + layer_id + '"><input type="text" class="not" name="positionX" id="posX' + layer_id + '"><input type="text" class="not" name="positionY" id="posY' + layer_id + '"></br><div id="easy-hide' + layer_id + '"><textarea name="body" class="leaf-body" id="leaf-body' + layer_id + '"></textarea></div></br><input type="submit" value="save" class="save"></div></form></div><div class="line-box right-down-line" id="line' + layer_id + '" style="left: ' + line_left + 'px; top: ' + line_top + 'px; width: 300px; height: 0px;"></div>')
      setTimeout(function(){
        $("#posX" + layer_id).val(300);
        $("#posY" + layer_id).val(0);
        $("#parent" + layer_id).val(this_id);
      }, 200);
      $('.tooltip').hide();
      $('.easy-hide').hide();
      eazy_mde['easyMDE' + layer_id] = new EasyMDE({element: document.getElementById("leaf-body" + layer_id + ""), maxHeight: "550px"});
  });
  //左
  $(document).on('click','#left-branch', function(evt){
      p1 = $(evt.target).closest(".leaf").position();
      var parent_elem = (evt.target).closest(".leaf");
      var parent_id = $(parent_elem).attr('id');
      console.log("parent_id" + parent_id);
      var parent_all_pos = $('#' + parent_id).position();
      var parent_posX = parent_all_pos.left;
      var parent_posY = parent_all_pos.top;
      layer_id++;
      pX1 = parent_posX - 300;
      pY1 = parent_posY;
      var line_left = parent_posX - 300;
      var line_top = parent_posY + 70;
      var setX = -300;
      var setY = 0;
      setTimeout(function(){
        $.ajax({url: "layers/new", type: "GET", data: {layer_id: layer_id, setX: setX, setY: setY, parent_id: this_id, user_id: fk_user_id, tree_id: fk_tree_id}});
      }, 100);
      $(event.target).closest(".leaf").after('<div class="leaf left-down" id="' + layer_id + '" style="left: ' + pX1 + 'px; top: ' + pY1 + 'px;">' + layer_id + '<input type="hidden" name="_method" value="patch" /><input type="hidden" id="db_id" name="db_id" value="' + gon.db_id + '"><input type="hidden" id="layer_id" name="layer_id" value="' + layer_id + '"><input type="hidden" id="user_id" name="user_id" value="' + fk_user_id + '"><input class="title" type="text" name="title"></br><button id="left-branch">+</button><button id="left-down-branch">+</button><button id="right-down-branch">+</button><button id="right-branch">+</button><div class="tooltip" id="tooltip-id' + layer_id + '"><button id="close-window">×</button><input type="text" class="parent not" name="parent_id" id="parent' + layer_id + '"><input type="text" class="not" name="positionX" id="posX' + layer_id + '"><input type="text" class="not" name="positionY" id="posY' + layer_id + '"></br><div id="easy-hide' + layer_id + '"><textarea name="body" class="leaf-body" id="leaf-body' + layer_id + '"></textarea></div></br><input type="submit" value="save" class="save"></div></form></div><div class="line-box left-down-line" id="line' + layer_id + '" style="left: ' + line_left + 'px; top: ' + line_top + 'px; width: 300px; height: 0px;"></div>')
      setTimeout(function(){
        $("#posX" + layer_id).val(-300);
        $("#posY" + layer_id).val(0);
        $("#parent" + layer_id).val(this_id);
      }, 200);
      $('.tooltip').hide();
      $('.easy-hide').hide();
      eazy_mde['easyMDE' + layer_id] = new EasyMDE({element: document.getElementById("leaf-body" + layer_id + ""), maxHeight: "550px"});
  });
  //マウスポインターの現在地表示
  $(window).mousemove(function(e) {
    $(".client").text("client : X" + e.clientX + " : Y" + e.clientY);
  });
  /*$(document).on('click','#left-down-branch', function(evt){
      p1 = $(evt.target.parentNode).position();
      i++;
      pX1 = p1.left - 150;
      pY1 = p1.top + 100;
     $(event.target.parentNode).after('<div class="leaf" id="' + i + '" style="left: ' + pX1 + 'px; top: ' + pY1 + 'px;"><button id="del">del</button><input type="text" name="content"></br><button id="left-branch">left</button><button id="left-down-branch">leftdown</button><button id="right-down-branch">rightdown</button><button id="right-branch">right</button><div class="tooltip"><textarea></textarea><p>テキストボックスのツールチップ</p></div>')
  });*/
  //ボックスを削除
  /*$(document).on('click','#del', function(evt){
    $(event.target.parentNode).remove();
    var del_id = $(event.target.parentNode).attr('id');
    $.ajax({url: "layers/" + del_id + "", type: "POST", data: {"id":del_id,"_method": "DELETE"} });
  });*/
  //ツリーをドラッグで移動
  $(function() {
    //ドラッグフラグ
    var drag_flg = false;
    //マウスダウンの位置
    var pos1;
    var pos2;
    //要素位置の修正値
    var posX1;
    var posY1;

    var p3;
    var pX3;
    var pY3;
    var mc = 0;
    //要素内でマウスボタンが押された場合
    $(".tree-wrapper").mousedown(function(evt1) {

      if(mc == 0){
        p3 = $(".leaf").position();
        pX3 = p3.left;
        pY3 = p3.top;
        tree_pos = $(".tree_title").position();
        title_posX = tree_pos.left;
        title_posY = tree_pos.top;
        $("#posX").val(pX3);
        $("#posY").val(pY3);
        mc++;
      }
        //ドラッグ判定（ドラッグしてない場合）
          if(drag_flg == false) {

              //要素の位置取得
              pos1 = $(".tree-wrapper").position();
              //要素位置を取得して修正値を計算
              posX1 = evt1.clientX - pos1.left;
              posY1 = evt1.clientY - pos1.top;
    
              //ドラッグ中にする
              drag_flg = true;
              //要素のテキストを変更
    
          //ドラッグ中の場合
          } else if(drag_flg == true) {
    
              //要素のドラッグを解除
              drag_flg = false;
              //要素のテキストを変更
              
          }
    });
 
    //要素上でマウスボタンが離された場合
    $(document).mouseup(function() {
        //要素のドラッグを解除
        drag_flg = false;
        //要素のテキストを変更
        
    });

    //ドキュメント上でマウスポインタが動いた場合
    $(document).mousemove(function(evt2) {
        //ドラッグ中の場合
        if(drag_flg == true) {
            //要素位置をCSSで設定
            $(".tree-wrapper").css("left",(evt2.clientX - posX1));
            $(".tree-wrapper").css("top",(evt2.clientY - posY1));
            $("#posX1").val(pX3 + evt2.clientX - posX1);
            $("#posY1").val(pY3 + evt2.clientY - posY1);
            tree_pos = $(".tree_title").position();
            title_posX = tree_pos.left;
            title_posY = tree_pos.top;
        }
    });
  });

  //クリックしたボックスのbodyを出現
  $(document).on('click','.leaf', function(evt){    
      $('this_id .tooltip').show();
      $(this).find('.tooltip').fadeIn('fast');
  });
  //クリックしたボックスのbodyを隠す
  $(document).on('click','#close-window', function(evt){ 
      $('this_id .tooltip').hide();
      $(this).parent('.tooltip').fadeOut('fast');
      $('.tooltip').css({'position':'absolute','left':'','top':'','width':'','height':''});
      evt.stopPropagation()
  });
  //吹き出しをマウスオーバーで拡大表示
  $(document).ready(function(){
    $(document).on({
      'mouseenter' : function() {
        jQuery(":hover").each(function () { 
          var tooltip_id = $(event.target).attr("id");
          easy_hide_id = $(event.target).find(".leaf").attr("id");
          if(tooltip_id?.match(/tooltip/)){ 
            var tooltip_size = document.getElementById(tooltip_id);    
            tooltip_size.style.width = "1280px";
            tooltip_size.style.height = "720px"; 
            $('#easy-hide' + this_id).show();
            console.log('#easy-hide' + this_id)
            $(document).on('click','.tooltip', function(){
              //document.getElementsByClassName(".tooltip").style.zIndex = 1;
              $('.tooltip').css({'z-index':'1'});
              z_index_cnt += 1;
              tooltip_size.style.zIndex = z_index_cnt;
            });
          }
        })
      },
      'mouseleave' : function(){
        jQuery(":hover").each(function () { 
          var tooltip_id = $(event.target).attr("id");
          if(tooltip_id?.match(/tooltip/)){ 
            var tooltip_size = document.getElementById(tooltip_id);
            tooltip_size.style.width = "";
            tooltip_size.style.height = "";
            tooltip_size.style.zIndex = 1;
            $('#easy-hide' + this_id).hide();
          }
        })
      }
    }, '.leaf')
  });
</script>
